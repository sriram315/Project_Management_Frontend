# # .github/workflows/deploy.yml
# name: Deploy Project Management Frontend

# on:
#   push:
#     branches: [ "main" ]
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Upload project to VM
#         uses: appleboy/scp-action@v0.1.4
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USER }}
#           password: ${{ secrets.SSH_PASSWORD }}
#           port: ${{ secrets.SSH_PORT || 22 }}
#           source: "."
#           target: "~/app-pm-frontend"
#           overwrite: true
#           rm: true

#       - name: Build & run container on VM
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USER }}
#           password: ${{ secrets.SSH_PASSWORD }}
#           port: ${{ secrets.SSH_PORT || 22 }}
#           envs: GITHUB_SHA
#           script: |
#             set -e
#             cd ~/app-pm-frontend

#             echo "ðŸ›‘ Stopping any running container..."
#             docker stop pm-frontend || true
#             docker rm pm-frontend || true

#             echo "âš™ï¸  Disabling Docker BuildKit to avoid buildx errors..."
#             export DOCKER_BUILDKIT=0
#             echo "âœ… BuildKit disabled. Proceeding with build..."

#             echo "ðŸ—ï¸  Building Docker image..."
#             docker build -t pm-frontend:${GITHUB_SHA} .

#             echo "ðŸš€ Running new container..."
#             docker run -d --name pm-frontend \
#               --restart unless-stopped \
#               -p 3005:80 \
#               pm-frontend:${GITHUB_SHA}

#             echo "ðŸ§¹ Cleaning up unused images..."
#             docker image prune -f

#             echo "âœ… Deployment completed successfully!"



name: Deploy Project Management Frontend (static)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  PUBLISH_DIR: build    # change to "dist" if your build outputs to dist/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Archive build folder
        run: |
          if [ ! -d "${{ env.PUBLISH_DIR }}" ]; then
            echo "ERROR: Build folder '${{ env.PUBLISH_DIR }}' not found. Check your build command and PUBLISH_DIR."
            exit 1
          fi
          tar -czf build.tar.gz -C "${{ env.PUBLISH_DIR }}" .
        shell: bash

      - name: Upload build to VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "build.tar.gz"
          target: "~/app-pm-frontend"
          overwrite: true
          rm: true
          debug: true

      - name: Extract & serve on VM (pm2 serve)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            mkdir -p ~/app-pm-frontend
            cd ~/app-pm-frontend

            # clean previous content
            rm -rf ./current || true
            mkdir -p ./current

            # extract uploaded build into `current`
            tar -xzf build.tar.gz -C ./current

            # ensure Node/npm are installed (if not, try to install via apt â€” adjust if your distro differs)
            if ! command -v node >/dev/null 2>&1; then
              echo "[info] node not found â€” installing node (requires sudo)"
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # install pm2 and serve if missing (global)
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "[info] Installing pm2 globally (requires sudo)"
              sudo npm install -g pm2
            fi

            if ! npm list -g serve >/dev/null 2>&1; then
              echo "[info] Installing serve globally (requires sudo)"
              sudo npm install -g serve
            fi

            # start/replace pm2 process to serve static files on port 80 (change port if needed)
            # Note: serving on port 80 requires root or proper capabilities; we use pm2 to run as root via sudo
            pm2 stop pm-frontend || true
            pm2 delete pm-frontend || true

            # Use pm2 to run serve from the 'current' folder
            # -l 80 to listen on port 80 (use smaller port e.g., 3005 if you cannot bind to 80)
            # If binding to 80 fails due to permissions, run on 3005 and use nginx to reverse-proxy
            pm2 start serve --name pm-frontend -- -s ~/app-pm-frontend/current -l 80

            pm2 save

            echo "âœ… Deployment completed. pm2 status:"
            pm2 status
